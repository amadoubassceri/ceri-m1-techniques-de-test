version: 2.1

# Import the Codecov orb
orbs:
  codecov: codecov/codecov@4.0.1

jobs:
  build-and-test:
    docker:
      - image: cimg/openjdk:11.0  # Utilisation de l'image OpenJDK 11 pour le build
    steps:
      - checkout  # Étape de checkout du code

      # Build le projet et génère la Javadoc
      - run:
          name: Build and Package
          command: mvn -B -DskipTests clean package

      # Génération de la Javadoc
      - run:
          name: Generate Javadoc
          command: mvn javadoc:javadoc

      # Lancer les tests et générer le rapport de couverture
      - run:
          name: Test
          command: mvn test

      - run:
          name: Generate Code Coverage Report
          command: mvn jacoco:report

      # Vérification avec Checkstyle
      - run:
          name: Run Checkstyle Verification
          command: mvn checkstyle:check

      # Générer le rapport HTML Checkstyle
      - run:
          name: Generate Checkstyle HTML Report
          command: mvn checkstyle:checkstyle

      # Télécharger le rapport de couverture vers Codecov
      - run:
          name: Upload to Codecov
          command: bash <(curl -s https://codecov.io/bash) -t $CODECOV_TOKEN

  deploy-gh-pages:
    docker:
      - image: cimg/python:3.8  # Utilisation de Python pour le déploiement sur GitHub Pages
    steps:
      - checkout  # Étape de checkout du code

      # Installer les dépendances nécessaires pour le déploiement sur GitHub Pages
      - run:
          name: Install GitHub Pages Deploy Dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y curl git
            curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash -  # Mise à jour vers Node.js 18.x
            sudo apt-get install -y nodejs
            sudo npm install -g gh-pages  # Installer gh-pages

      # Déployer la Javadoc sur GitHub Pages
      - run:
          name: Deploy Javadoc to GitHub Pages
          command: |
            git config --global user.name "CircleCI"  # Configuration utilisateur Git
            git config --global user.email "circleci@example.com"  # Configuration email Git
            git remote set-url origin https://${GH_TOKEN}@github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.git  # Authentification via token
            gh-pages -d target/site/apidocs  # Déployer le dossier de la Javadoc sur la branche gh-pages

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build-and-test  # Job de test et de génération de la Javadoc
      - deploy-gh-pages:  # Job de déploiement sur GitHub Pages
          requires:
            - build-and-test  # Dépendance du job build-and-test
