version: 2.1

jobs:
  build-and-test:
    docker:
      - image: cimg/openjdk:11.0
    steps:
      - checkout
      - run:
          name: Construire le projet
          command: mvn -B -DskipTests clean package
      - run:
          name: Lancer les tests
          command: mvn test
      - run:
          name: Générer le rapport de couverture de code
          command: mvn jacoco:report
      - run:
          name: Vérification avec Checkstyle
          command: mvn checkstyle:check
      - run:
          name: Générer le rapport HTML Checkstyle
          command: mvn checkstyle:checkstyle
      - run:
          name: Envoyer à Codecov
          command: bash <(curl -s https://codecov.io/bash) -t $CODECOV_TOKEN

  deploy-gh-pages:
    docker:
      - image: cimg/openjdk:11.0
    steps:
      - checkout
      - run:
          name: Configurer Git
          command: |
            export CIRCLE_SKIP_UNCHANGED_BUILDS=false
            git config --global user.email "narutokonoya1@gmail.com"
            git config --global user.name "amadoubassceri"
      - run:
          name: Déployer sur GitHub Pages
          command: |
            # Cloner le dépôt dans le répertoire `gh-pages`
            git clone https://${GH_TOKEN_GITHUB}@github.com/amadoubassceri/ceri-m1-techniques-de-test.git gh-pages
            cd gh-pages
            # Vérifier si la branche `gh-pages` existe et se positionner dessus
            git checkout gh-pages || git checkout -b gh-pages
            # Supprimer les anciens fichiers dans `gh-pages` pour ne garder que ceux de Javadoc
            rm -rf *
            # Copier la documentation Javadoc générée dans `gh-pages`
            cp -r ../target/site/apidocs/* .
            # Ajouter tous les fichiers modifiés
            git add -A
            # Vérifier s'il y a des modifications à committer
            if git diff-index --quiet HEAD; then
              echo "Aucune modification à commiter"
            else
              git commit -m "Mise à jour Javadoc"
              # Pousser les modifications sur la branche `gh-pages`
              git push https://${GH_TOKEN_GITHUB}@github.com/amadoubassceri/ceri-m1-techniques-de-test.git gh-pages --force
            fi

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build-and-test:
          filters:
            branches:
              only:
                - master
      - deploy-gh-pages:
          requires:
            - build-and-test
          filters:
            branches:
              only:
                - master
